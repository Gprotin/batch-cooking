<script>
    // Ajout de "tags" pour la diversit√© : [Prot√©ine, Sauce/Style, F√©culent]
    const recipesDB = [
  {
    "id": 1,
    "nom": "Bolognaise de Dinde aux L√©gumes Cach√©s",
    "tags": ["kids", "light", "batch"],
    "ingredients": [
      {"nom": "Hach√© de dinde", "quantite": 500, "unite": "g"},
      {"nom": "Spaghetti complets", "quantite": 400, "unite": "g"},
      {"nom": "Carottes", "quantite": 3, "unite": "pi√®ces"},
      {"nom": "Courgettes", "quantite": 2, "unite": "pi√®ces"},
      {"nom": "Coulis de tomate", "quantite": 500, "unite": "ml"},
      {"nom": "Oignon", "quantite": 1, "unite": "pi√®ce"}
    ],
    "instructions": "R√¢per les l√©gumes. Faire revenir oignon et dinde. Ajouter l√©gumes et coulis. Mijoter 30min."
  },
  {
    "id": 2,
    "nom": "Dahl de Lentilles Corail au Lait de Coco Light",
    "tags": ["veggie", "kids", "batch"],
    "ingredients": [
      {"nom": "Lentilles corail", "quantite": 300, "unite": "g"},
      {"nom": "Lait de coco all√©g√©", "quantite": 400, "unite": "ml"},
      {"nom": "Riz basmati", "quantite": 250, "unite": "g"},
      {"nom": "Epinards frais", "quantite": 200, "unite": "g"},
      {"nom": "Curry doux", "quantite": 1, "unite": "cas"},
      {"nom": "Oignon", "quantite": 1, "unite": "pi√®ce"}
    ],
    "instructions": "Cuire oignon et √©pices. Ajouter lentilles, eau et lait de coco. Cuire 20min. Ajouter √©pinards √† la fin."
  },
  {
    "id": 3,
    "nom": "Chili Con Carne Doux (B≈ìuf 5%)",
    "tags": ["proteine", "batch"],
    "ingredients": [
      {"nom": "Boeuf hach√© 5%", "quantite": 500, "unite": "g"},
      {"nom": "Haricots rouges", "quantite": 400, "unite": "g"},
      {"nom": "Ma√Øs", "quantite": 150, "unite": "g"},
      {"nom": "Poivrons rouges", "quantite": 2, "unite": "pi√®ces"},
      {"nom": "Pulpe de tomate", "quantite": 400, "unite": "g"},
      {"nom": "Riz complet", "quantite": 250, "unite": "g"}
    ],
    "instructions": "Dorer la viande et poivrons. Ajouter tomate, haricots, ma√Øs. Mijoter 40min. Servir avec riz."
  },
  {
    "id": 4,
    "nom": "Frittata aux Pommes de Terre et Brocolis",
    "tags": ["oeuf", "kids", "rapide"],
    "ingredients": [
      {"nom": "Oeufs", "quantite": 8, "unite": "pi√®ces"},
      {"nom": "Pommes de terre", "quantite": 400, "unite": "g"},
      {"nom": "Brocolis", "quantite": 1, "unite": "t√™te"},
      {"nom": "Fromage r√¢p√© l√©ger", "quantite": 100, "unite": "g"},
      {"nom": "Lait", "quantite": 100, "unite": "ml"}
    ],
    "instructions": "Cuire PDT et brocolis √† l'eau. Battre oeufs/lait. Tout m√©langer et cuire au four 20min √† 180¬∞C."
  },
  {
    "id": 5,
    "nom": "Poulet Basquaise Express",
    "tags": ["light", "volaille"],
    "ingredients": [
      {"nom": "Blancs de poulet", "quantite": 600, "unite": "g"},
      {"nom": "Poivrons tricolores", "quantite": 3, "unite": "pi√®ces"},
      {"nom": "Tomates concass√©es", "quantite": 400, "unite": "g"},
      {"nom": "Quinoa", "quantite": 250, "unite": "g"},
      {"nom": "Ail", "quantite": 1, "unite": "gousse"}
    ],
    "instructions": "Couper poulet et poivrons en d√©s. Faire revenir. Ajouter tomates. Cuire 20min. Servir avec quinoa."
  }
];

    const KID_RATIO = 0.5;

    function generateMenu() {
        let daysRequested = parseInt(document.getElementById('daysCount').value) || 5;
        const adults = parseInt(document.getElementById('nbAdults').value) || 0;
        const kids = parseInt(document.getElementById('nbKids').value) || 0;
        const totalParts = adults + (kids * KID_RATIO);

        const selectedMenu = [];
        const usedTags = {};
        const shuffledPool = [...recipesDB].sort(() => 0.5 - Math.random());

        for (let recipe of shuffledPool) {
            if (selectedMenu.length >= daysRequested) break;

            // V√©rifier si un tag de la recette est d√©j√† trop utilis√© (max 2 fois le m√™me tag par semaine)
            const hasTooMuchRedundancy = recipe.tags.some(tag => (usedTags[tag] || 0) >= 2);

            if (!hasTooMuchRedundancy) {
                selectedMenu.push(recipe);
                recipe.tags.forEach(tag => {
                    usedTags[tag] = (usedTags[tag] || 0) + 1;
                });
            }
        }

        // Si apr√®s le filtrage on n'a pas assez de recettes, on compl√®te sans filtrer
        if (selectedMenu.length < daysRequested) {
            for (let recipe of shuffledPool) {
                if (selectedMenu.length >= daysRequested) break;
                if (!selectedMenu.includes(recipe)) selectedMenu.push(recipe);
            }
        }
        
        displayMenu(selectedMenu);
        calculateShopping(selectedMenu, totalParts);
        document.getElementById('resultArea').classList.remove('hidden');
    }

    // Gardez les fonctions displayMenu, calculateShopping et exportToNotes identiques √† la version pr√©c√©dente
    function displayMenu(menu) {
        let html = "<ul>";
        window.currentMenuText = "";
        menu.forEach((recipe, i) => {
            html += `<li><strong>J${i+1}:</strong> ${recipe.nom}</li>`;
            window.currentMenuText += `J${i+1}: ${recipe.nom}\n`;
        });
        document.getElementById('menuOutput').innerHTML = html + "</ul>";
    }

    function calculateShopping(menu, totalPartsNeeded) {
        let ingredientsMap = {};
        menu.forEach(recipe => {
            const ratio = totalPartsNeeded / (recipe.nb_personnes_base || 4);
            recipe.ingredients.forEach(ing => {
                let key = ing.nom.toLowerCase().trim() + "_" + ing.unite.trim();
                if (!ingredientsMap[key]) {
                    ingredientsMap[key] = { name: ing.nom, qty: 0, unit: ing.unite };
                }
                ingredientsMap[key].qty += (ing.quantite * ratio);
            });
        });
        let html = "<ul>";
        window.currentShoppingText = "";
        Object.values(ingredientsMap).sort((a,b) => a.name.localeCompare(b.name)).forEach(item => {
            let displayQty = ['g','ml'].includes(item.unit.toLowerCase()) ? Math.ceil(item.qty) : item.qty.toFixed(1);
            let line = `${item.name}: ${displayQty} ${item.unit}`;
            html += `<li>${line}</li>`;
            window.currentShoppingText += `- [ ] ${line}\n`;
        });
        document.getElementById('shoppingListOutput').innerHTML = html + "</ul>";
    }

    async function exportToNotes() {
        const text = `üçé MON BATCH COOKING\n\nMENU :\n${window.currentMenuText}\nCOURSES :\n${window.currentShoppingText}`;
        if (navigator.share) {
            try { await navigator.share({ title: "Liste Courses", text: text }); } catch (e) {}
        } else {
            navigator.clipboard.writeText(text);
            alert("Copi√© !");
        }
    }
</script>
